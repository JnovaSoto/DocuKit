<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: navigation.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: navigation.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * SPA (Single Page Application) navigation handler.
 * Manages client-side routing, page transitions, and dynamic content loading.
 */

import logger from './tools/logger.js';

import { API, ROUTES } from './config/constants.js';
import { applyTheme, getCurrentTheme } from './tools/themeSwitch.js';

/**
 * Initializes the SPA navigation system on page load.
 */
document.addEventListener('DOMContentLoaded', async () => {
  await loadHeaderAndFooter();
  initNavigation();       // global SPA navigation buttons
  executePageScript();    // page-specific scripts
  handlePopState();       // handle back/forward
});

/**
 * Loads header and footer partials once on initial page load.
 * @returns {Promise&lt;void>} A promise that resolves when the header and footer are loaded.
 * @async
 */
async function loadHeaderAndFooter() {
  const header = document.querySelector('#header');
  const footer = document.querySelector('#footer');

  if (header &amp;&amp; header.innerHTML.trim() === '') {
    try {
      const response = await fetch(API.PARTIALS.HEADER);
      const html = await response.text();

      // Remove any meta tags from the header content
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      const metaTags = tempDiv.querySelectorAll('meta');
      metaTags.forEach(meta => meta.remove());

      header.innerHTML = tempDiv.innerHTML;

      // Initialize header scripts AFTER insertion
      import('/js/main/header.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/tags/getTag.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/properties/getProperty.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/tools/translation.js').then(mod => mod.init &amp;&amp; mod.init());

    } catch (err) {
      logger.error('Error loading header:', err);
    }
  }

  if (footer &amp;&amp; footer.innerHTML.trim() === '') {
    try {
      const response = await fetch(API.PARTIALS.FOOTER);
      const html = await response.text();

      // Remove any meta tags from the footer content
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      const metaTags = tempDiv.querySelectorAll('meta');
      metaTags.forEach(meta => meta.remove());

      footer.innerHTML = tempDiv.innerHTML;
    } catch (err) {
      logger.error('Error loading footer:', err);
    }
  }
}

/**
 * Sets up global SPA navigation using event delegation.
 * Listens for clicks on navigation buttons and triggers page changes.
 * Note: #btn-edit-tags is handled by edit.js to save tag ID before navigation
 * @fires {changePage} changePage
 */
function initNavigation() {
  document.body.addEventListener('click', e => {
    // Look for the closest anchor tag
    const link = e.target.closest('a');

    if (!link) return;

    const href = link.getAttribute('href');

    // Skip if no href, external link, or starts with # (hash anchor)
    if (!href || href.startsWith('http') || href.startsWith('#') || link.target === '_blank') {
      return;
    }

    // Skip OAuth and server-side authentication routes
    if (href.includes('/users/google') || href.includes('/auth/')) {
      return; // Don't intercept, let browser handle full redirect
    }

    // Special case for logout and other non-SPA actions if any
    if (link.id === 'btn-log-out') return;

    // Intercept internal navigation
    e.preventDefault();

    // Check for disabled state
    if (link.classList.contains('disabled')) return;

    // Handle login specific logic
    if (link.id === 'btn-log-in') {
      sessionStorage.setItem('returnPath', window.location.pathname);
    }

    changePage(href);
  });
}

/**
 * Changes the current page without full page reload.
 * Updates browser history and loads new content dynamically.
 * @async
 * @param {string} path - The path to navigate to
 * @fires {changePage} changePage
 */
import { requireLogin } from './tools/session.js';
import { showTemporaryAlert } from './tools/alerts.js';

// ... (existing imports)

/**
 * Renders a skeleton loader animation in the #app container
 * visual polish: display skeleton while loading
 */
function showSkeleton() {
  const app = document.querySelector('#app');
  if (!app) return;

  // Check if we are already showing a skeleton to avoid flickering
  if (app.querySelector('.skeleton-page')) return;

  app.innerHTML = `
      &lt;div class="skeleton-page" style="opacity: 0; animation: fadeIn 0.3s forwards;">
        &lt;div class="skeleton-header">
          &lt;div class="skeleton-header-left">
            &lt;div class="skeleton skeleton-title">&lt;/div>
            &lt;div class="skeleton skeleton-text" style="width: 80%">&lt;/div>
          &lt;/div>
          &lt;div class="skeleton skeleton-rect" style="width: 100px; height: 40px;">&lt;/div>
        &lt;/div>
        &lt;div class="skeleton skeleton-rect">&lt;/div>
        &lt;div class="skeleton-grid">
          &lt;div class="skeleton skeleton-rect" style="height: 150px">&lt;/div>
          &lt;div class="skeleton skeleton-rect" style="height: 150px">&lt;/div>
          &lt;div class="skeleton skeleton-rect" style="height: 150px">&lt;/div>
        &lt;/div>
      &lt;/div>
      &lt;style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      &lt;/style>
    `;
}

export async function changePage(path) {
  logger.navigation(`Navigating to: ${path}`);

  // Check if the route is protected
  const protectedRoutes = [ROUTES.CREATE, ROUTES.EDIT, ROUTES.PROFILE, ROUTES.FAVORITES];
  if (protectedRoutes.includes(path)) {
    if (!await requireLogin()) {
      showTemporaryAlert('alert', 'You must log in to access this page');
      // Optionally redirect to login if not already there
      if (window.location.pathname !== ROUTES.LOGIN) {
        changePage(ROUTES.LOGIN);
      }
      return;
    }
  }

  history.pushState(null, null, path);

  showSkeleton();

  fetch(path)
    .then(async response => {
      // Handle server-side redirects (e.g. if session expired during fetch)
      if (response.redirected) {
        const newUrl = new URL(response.url);
        const newPath = newUrl.pathname;
        logger.navigation(`Redirected to: ${newPath}`);
        history.replaceState(null, null, newPath);
        if (newPath === ROUTES.LOGIN) {
          showTemporaryAlert('alert', 'Session expired, please log in again');
        }
        return response.text();
      }
      return response.text();
    })
    .then(html => {
      const performUpdate = () => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        const newContent = doc.querySelector('#app') ? doc.querySelector('#app').innerHTML : null;

        if (!newContent) {
          logger.error('Could not find #app content in response');
          return;
        }

        // Remove any meta tags that might have been included in the content
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = newContent;
        const metaTags = tempDiv.querySelectorAll('meta');
        metaTags.forEach(meta => meta.remove());

        document.querySelector('#app').innerHTML = tempDiv.innerHTML;

        // Run page-specific scripts only
        executePageScript();
      };

      if (!document.startViewTransition) {
        performUpdate();
      } else {
        document.startViewTransition(() => performUpdate());
      }
    })
    .catch(err => logger.error('Page navigation error:', err));
}

/**
 * Executes page-specific JavaScript based on the current route.
 * Dynamically imports and initializes the appropriate module.
 * @async
 */
function executePageScript() {
  const path = window.location.pathname;
  logger.debug(`Executing scripts for path: ${path}`);

  // Helper to update header button text based on theme
  const updateHeaderButton = () => {
    const btnCreate = document.getElementById('btn-create-tags');
    if (btnCreate) {
      const currentTheme = getCurrentTheme();
      if (currentTheme === 'css') {
        btnCreate.textContent = 'Create property';
      } else {
        btnCreate.textContent = 'Create tags';
      }
    }
  };

  switch (path) {
    case '/':
    case ROUTES.HOME:
      // Force HTML theme on home page
      applyTheme('html');
      updateHeaderButton();
      import('../js/main/home.js').then(mod => mod.init &amp;&amp; mod.init());
      import('../js/tags/edit.js').then(mod => mod.init &amp;&amp; mod.init());
      import('../js/tags/delete.js').then(mod => mod.init &amp;&amp; mod.init());
      import('../js/tags/favorites.js').then(mod => mod.init &amp;&amp; mod.init());
      break;
    case '/css':
    case ROUTES.CSS:
    case '/css-properties':
      // Force CSS theme on CSS properties page
      applyTheme('css');
      updateHeaderButton();
      import('/js/main/css.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/properties/edit.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/properties/delete.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/properties/favorites.js').then(mod => mod.init &amp;&amp; mod.init());
      break;
    case ROUTES.CREATE:
      updateHeaderButton();
      if (getCurrentTheme() === 'css') {
        import('/js/properties/create.js').then(mod => mod.init &amp;&amp; mod.init());
      } else {
        import('/js/tags/create.js').then(mod => mod.init &amp;&amp; mod.init());
      }
      break;
    case ROUTES.EDIT:
      import('/js/tags/edit.js').then(mod => mod.init &amp;&amp; mod.init());
      break;
    case ROUTES.SIGNUP:
      import('/js/user/signUp.js').then(mod => mod.init &amp;&amp; mod.init());
      break;
    case ROUTES.LOGIN:
      import('/js/user/logIn.js').then(mod => mod.init &amp;&amp; mod.init());
      break;
    case ROUTES.PROFILE:
      import('/js/user/profile.js').then(mod => mod.init &amp;&amp; mod.init());
      break;
    case ROUTES.FAVORITES:
      updateHeaderButton();
      import('/js/tags/edit.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/tags/delete.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/properties/edit.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/properties/delete.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/tags/favorites.js').then(mod => mod.init &amp;&amp; mod.init());
      import('/js/user/favorites.js').then(mod => mod.init &amp;&amp; mod.init());
      break;
  }
}

/**
 * Handles browser back/forward button navigation.
 * Ensures page content updates when user uses browser navigation.
 * @fires {changePage} changePage
 */
function handlePopState() {
  window.addEventListener('popstate', () => {
    logger.navigation('Browser back/forward button used');
    changePage(location.pathname);
  });
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#ALERT_IDS">ALERT_IDS</a></li><li><a href="global.html#ALERT_TIMING">ALERT_TIMING</a></li><li><a href="global.html#API">API</a></li><li><a href="global.html#ERROR_MESSAGES">ERROR_MESSAGES</a></li><li><a href="global.html#HTTP_STATUS">HTTP_STATUS</a></li><li><a href="global.html#LOG_LEVELS">LOG_LEVELS</a></li><li><a href="global.html#ROUTES">ROUTES</a></li><li><a href="global.html#SESSION">SESSION</a></li><li><a href="global.html#SUCCESS_MESSAGES">SUCCESS_MESSAGES</a></li><li><a href="global.html#VALIDATION">VALIDATION</a></li><li><a href="global.html#addFavorite">addFavorite</a></li><li><a href="global.html#alert">alert</a></li><li><a href="global.html#applyTheme">applyTheme</a></li><li><a href="global.html#auth">auth</a></li><li><a href="global.html#checkSession">checkSession</a></li><li><a href="global.html#create">create</a></li><li><a href="global.html#darkThemes">darkThemes</a></li><li><a href="global.html#debug">debug</a></li><li><a href="global.html#deleteLog">deleteLog</a></li><li><a href="global.html#displayAttributeMetadata">displayAttributeMetadata</a></li><li><a href="global.html#edit">edit</a></li><li><a href="global.html#error">error</a></li><li><a href="global.html#executePageScript">executePageScript</a></li><li><a href="global.html#form">form</a></li><li><a href="global.html#generateAttributeBlock">generateAttributeBlock</a></li><li><a href="global.html#generateTable">generateTable</a></li><li><a href="global.html#getCurrentTheme">getCurrentTheme</a></li><li><a href="global.html#getCurrentUser">getCurrentUser</a></li><li><a href="global.html#getDarkMode">getDarkMode</a></li><li><a href="global.html#handlePopState">handlePopState</a></li><li><a href="global.html#handleResponseError">handleResponseError</a></li><li><a href="global.html#info">info</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initNavigation">initNavigation</a></li><li><a href="global.html#initSearch">initSearch</a></li><li><a href="global.html#initTheme">initTheme</a></li><li><a href="global.html#isDevelopment">isDevelopment</a></li><li><a href="global.html#lightThemes">lightThemes</a></li><li><a href="global.html#loadCssFavorites">loadCssFavorites</a></li><li><a href="global.html#loadEditForm">loadEditForm</a></li><li><a href="global.html#loadHeaderAndFooter">loadHeaderAndFooter</a></li><li><a href="global.html#loadTagFavorites">loadTagFavorites</a></li><li><a href="global.html#navigation">navigation</a></li><li><a href="global.html#network">network</a></li><li><a href="global.html#reloadHeader">reloadHeader</a></li><li><a href="global.html#removeFavorite">removeFavorite</a></li><li><a href="global.html#renderTable">renderTable</a></li><li><a href="global.html#requireAdmin">requireAdmin</a></li><li><a href="global.html#requireLogin">requireLogin</a></li><li><a href="global.html#resetInit">resetInit</a></li><li><a href="global.html#setupDarkModeToggle">setupDarkModeToggle</a></li><li><a href="global.html#setupSubmitHandler">setupSubmitHandler</a></li><li><a href="global.html#setupThemeSwitcher">setupThemeSwitcher</a></li><li><a href="global.html#showSkeleton">showSkeleton</a></li><li><a href="global.html#showTemporaryAlert">showTemporaryAlert</a></li><li><a href="global.html#success">success</a></li><li><a href="global.html#tag">tag</a></li><li><a href="global.html#toggleDarkMode">toggleDarkMode</a></li><li><a href="global.html#toggleTheme">toggleTheme</a></li><li><a href="global.html#user">user</a></li><li><a href="global.html#warn">warn</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.5</a> on Tue Dec 30 2025 11:37:52 GMT+0100 (hora est√°ndar de Europa central)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
